/* 
    Database deploy script (MySQL)
    Generated: 2026-01-13 16:38:39
*/

/*** BEGIN InitDbTest.MySQL ***/

CREATE TABLE IF NOT EXISTS `__EFMigrationsHistory` (
    `MigrationId` varchar(150) CHARACTER SET utf8mb4 NOT NULL,
    `ProductVersion` varchar(32) CHARACTER SET utf8mb4 NOT NULL,
    CONSTRAINT `PK___EFMigrationsHistory` PRIMARY KEY (`MigrationId`)
) CHARACTER SET=utf8mb4;

START TRANSACTION;

ALTER DATABASE CHARACTER SET utf8mb4;

CREATE TABLE `my_MyTable` (
    `Id` bigint NOT NULL AUTO_INCREMENT,
    `RowID` char(36) COLLATE ascii_general_ci NOT NULL,
    `LastChanged` datetime(6) NOT NULL,
    `LastChangedBy` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    CONSTRAINT `PK_my_MyTable` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;

CREATE TABLE `my_MyTableRef` (
    `Id` bigint NOT NULL AUTO_INCREMENT,
    `ParentId` bigint NOT NULL,
    `MyInfo` varchar(256) CHARACTER SET utf8mb4 NOT NULL,
    `LastChanged` datetime(6) NOT NULL,
    `LastChangedBy` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    CONSTRAINT `PK_my_MyTableRef` PRIMARY KEY (`Id`),
    CONSTRAINT `FK_my_MyTableRef_my_MyTable_ParentId` FOREIGN KEY (`ParentId`) REFERENCES `my_MyTable` (`Id`) ON DELETE RESTRICT
) CHARACTER SET=utf8mb4;

INSERT INTO `my_MyTable` (`Id`, `LastChanged`, `LastChangedBy`, `RowID`)
VALUES (-2, TIMESTAMP '1970-01-01 00:00:00', 'Stefan', '6a3bf170-797c-40ba-ad8b-76e6ac34614a'),
(-1, TIMESTAMP '1970-01-01 00:00:00', 'Baldr', 'e781aa56-299c-4e18-91cd-89cb1544fc3a');

INSERT INTO `my_MyTableRef` (`Id`, `LastChanged`, `LastChangedBy`, `MyInfo`, `ParentId`)
VALUES (-3, TIMESTAMP '1970-01-01 00:00:00', 'Stefan', 'OtherData', -2),
(-2, TIMESTAMP '1970-01-01 00:00:00', 'Baldr', 'BiggerData', -1),
(-1, TIMESTAMP '1970-01-01 00:00:00', 'Baldr', 'BigData', -1);

CREATE INDEX `IX_my_MyTable_LastChanged` ON `my_MyTable` (`LastChanged`);

CREATE UNIQUE INDEX `IX_my_MyTable_RowID` ON `my_MyTable` (`RowID`);

CREATE INDEX `IX_my_MyTableRef_MyInfo` ON `my_MyTableRef` (`MyInfo`);

CREATE INDEX `IX_my_MyTableRef_ParentId` ON `my_MyTableRef` (`ParentId`);

INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
VALUES ('20260113163835_InitDbTest', '8.0.21');

COMMIT;


/*** END InitDbTest.MySQL ***/


/*** BEGIN MySQL.MySQL ***/

-- Mysql has no sequences, use table instead
CREATE TABLE IF NOT EXISTS my_Sequences (
    Name VARCHAR(50) NOT NULL PRIMARY KEY,
    NextValue BIGINT NOT NULL
);

INSERT INTO my_Sequences (Name, NextValue) VALUES ('MySeqId', 1);

DELIMITER $$
CREATE PROCEDURE my_ReserveMyIds (IN IdCount INT)
BEGIN
    DECLARE StartBase BIGINT;
    DECLARE i INT;
    -- Step 1–2: Atomically update and get the starting value
    START TRANSACTION;
    -- Read current value
    SELECT NextValue INTO StartBase
    FROM my_Sequences
    WHERE Name = 'MySeqId'
    FOR UPDATE;
    -- Increment the stored value by IdCount
    UPDATE my_Sequences
    SET NextValue = NextValue + IdCount
    WHERE Name = 'MySeqId';
    COMMIT;
    -- Step 3–4: Return the list of reserved IDs
    SET i = 0;
    CREATE TEMPORARY TABLE tmp_ReservedIds (ReservedId BIGINT);
    WHILE i < IdCount DO
        INSERT INTO tmp_ReservedIds (ReservedId)
        VALUES (StartBase + i);
        SET i = i + 1;
    END WHILE;
    SELECT ReservedId FROM tmp_ReservedIds;
    DROP TEMPORARY TABLE tmp_ReservedIds;
END$$
DELIMITER ;

DELIMITER $$
-- Stored procedure test scalar result
CREATE PROCEDURE my_GetMaxIdByChanger(IN Changer VARCHAR(50))
BEGIN
    SELECT MAX(Id)
    FROM my_MyTable
    WHERE LastChangedBy = Changer;
END$$

DELIMITER ;
CREATE OR REPLACE VIEW my_MyTableRefView AS
SELECT
    r.Id           AS RefId,
    t.Id           AS MyId,
    t.RowID,
    t.LastChanged,
    t.LastChangedBy,
    r.MyInfo,
    r.LastChanged  AS RefLastChanged,
    r.LastChangedBy AS RefLastChangedBy
FROM my_MyTableRef AS r
INNER JOIN my_MyTable AS t ON t.Id = r.ParentId;

DELIMITER $$
CREATE PROCEDURE my_GetMyTableRefViewByMyId(IN MyId BIGINT)
BEGIN
    SELECT
        v.RefId,
        v.MyId,
        v.RowID,
        v.LastChanged,
        v.LastChangedBy,
        v.MyInfo,
        v.RefLastChanged,
        v.RefLastChangedBy
    FROM my_MyTableRefView AS v
    WHERE v.MyId = MyId;
END$$
DELIMITER ;

/*** END MySQL.MySQL ***/

